%!TEX TS-program = xelatex
%!TEX encoding = UTF-8 Unicode

\documentclass[$fontsize$, a4paper, svgnames]{report}
\usepackage{xcolor}
\definecolor{mpx-brown}{HTML}{534022}
\definecolor{mpx-grey}{HTML}{BFBFBF}
\definecolor{mpx-lightgrey}{HTML}{F3F3F3}
\definecolor{mpx-blue}{HTML}{4A5B72}
\definecolor{mpx-lightblue}{HTML}{DCDEE0}

% LAYOUT
%--------------------------------
\usepackage{geometry}
\geometry{$geometry$}

% No page numbers
\pagenumbering{gobble}

% Left align
\usepackage[document]{ragged2e}

% TYPOGRAPHY
%--------------------------------
\usepackage{fontspec} 
\usepackage{xunicode}
\usepackage{xltxtra}
\defaultfontfeatures{Mapping=tex-text} % converts LaTeX specials (quotes, dashes etc.) to Unicode
\usepackage{lmodern}
\usepackage{fontawesome5}
\usepackage{longfbox}

\usepackage{tikz}
\usepackage[explicit]{titlesec}

\newcommand*\HeaderDocumentDetails{%
  \begin{tikzpicture}[remember picture,overlay]
    \fill[mpx-brown] (current page.north west) -- (current page.north east) --
      ([yshift=-0.2cm]current page.north east) -- ([yshift=-0.2cm]current page.north west) -- cycle;
    \fill[mpx-lightgrey] ([yshift=-0.2cm]current page.north west) -- ([yshift=-0.2cm]current page.north east) -- 
      ([yshift=-3cm]current page.north east) -- ([yshift=-3cm]current page.north west) -- cycle;
  \end{tikzpicture}%
}

\newcommand*\HeaderSimple{%
  \begin{tikzpicture}[remember picture,overlay]
    \fill[mpx-brown] (current page.north west) -- (current page.north east) --
      ([yshift=-0.2cm]current page.north east) -- ([yshift=-0.2cm]current page.north west) -- cycle;
    \fill[mpx-lightgrey] ([yshift=-0.2cm]current page.north west) -- ([yshift=-0.2cm]current page.north east) -- 
      ([yshift=-2cm]current page.north east) -- ([yshift=-2cm]current page.north west) -- cycle;
  \end{tikzpicture}%
}

\usetikzlibrary{matrix}
\newcommand\FooterCompanyDetails{%
  \begin{tikzpicture}[remember picture,overlay]
    \node[yshift=5cm,xshift=1cm,anchor=south west,inner sep=3pt](payementdue-bg) at (current page.south west)
      {\small \sffamily \textsc{$lang.payement-due-text$}};
    \fill[mpx-lightgrey] ([yshift=5cm]current page.south west) [rounded corners=0.1cm] -- 
      ([xshift=-0.1cm]payementdue-bg.south west) [rounded corners=0.1cm] -- 
      (payementdue-bg.north west) [rounded corners=0.1cm] -- 
      (payementdue-bg.north east) [rounded corners=0.1cm] -- 
      ([xshift=0.1cm]payementdue-bg.south east) -- 
      ([yshift=5cm]current page.south east) --
      ([yshift=0.5cm]current page.south east) -- 
      ([yshift=0.5cm]current page.south west) -- cycle;
    \draw[mpx-grey] ([yshift=5cm]current page.south west) [rounded corners=0.1cm] -- 
      ([xshift=-0.1cm]payementdue-bg.south west) [rounded corners=0.1cm] -- 
      (payementdue-bg.north west) [rounded corners=0.1cm] -- 
      (payementdue-bg.north east) [rounded corners=0.1cm] -- 
      ([xshift=0.1cm]payementdue-bg.south east) --
      ([yshift=5cm]current page.south east);
    \node[yshift=5cm,xshift=1cm,anchor=south west,inner sep=3pt](payementdue) at (current page.south west)
      {\small \sffamily \textsc{$lang.payement-due-text$}};
    \matrix[
      %draw,nodes=draw,
      yshift=4cm,
      matrix of nodes, 
      nodes={minimum height=1.5em, anchor=center},
      row 1 column 1/.style={align=center,text width=5cm,font=\large},
      ampersand replacement=\&
     ](companyinfo) at (current page.south)
     {
      \node{\textbf{$from.name$} $from.legalform$}; \\
      \node{$from.vat$}; \\
     };
     \matrix[
      %draw,nodes=draw,
      yshift=2cm,
      matrix of nodes, 
      nodes={minimum height=1.5em, anchor=west, font=\footnotesize},
      row 1 column 1/.style={text width=6cm},
      row 1 column 2/.style={text width=6cm},
      row 1 column 3/.style={text width=4cm},
      ampersand replacement=\&
     ](companydetails) at (current page.south)
     {
      \node(addr1){\makebox[6mm][c]{\faBuilding[regular]}$from.address.line-one$};           \& \node(bank)[xshift=-3mm]{\makebox[6mm][c]{\faUniversity}$from.bank.name$};                                                                                                         \& \node{\makebox[6mm][c]{\faMobile*}{$from.phone$}}; \\
      \node(addr2)[right=6mm] at (addr1.west) {$from.address.zip-code$ $from.address.city$}; \& \node(bic)[anchor=west, right=4mm] at (bank.west){\lfbox[border-radius=0.5ex,border-color=mpx-lightblue]{\makebox[8mm][c]{\tiny{BIC}}}\makebox[2mm]{}$from.bank.bic$};             \& \node{\makebox[6mm][c]{\faAt}\href{mailto:$from.online.e-mail$}{$from.online.e-mail$}}; \\
      \node(addr3)[right=6mm] at (addr1.west) {$from.address.country$};                      \& \node(iban)[anchor=west, right=4mm] at (bank.west){\lfbox[border-radius=0.5ex,border-color=mpx-lightblue]{\makebox[8mm][c]{\tiny{IBAN}}}\makebox[2mm]{}\textbf{$from.bank.iban$}}; \& \node{\makebox[6mm][c]{\faGlobe}\url{$from.online.website$}}; \\
     };
    \fill[mpx-brown] (current page.south west) -- (current page.south east) --
      ([yshift=0.5cm]current page.south east) -- ([yshift=0.5cm]current page.south west) -- cycle;
  \end{tikzpicture}%
}

\newcommand\FooterSimple{%
  \begin{tikzpicture}[remember picture,overlay]
    \fill[mpx-lightgrey] ([yshift=0.5cm]current page.south west) -- ([yshift=0.5cm]current page.south east) --
      ([yshift=2cm]current page.south east) -- ([yshift=2cm]current page.south west) -- cycle;
    \fill[mpx-brown] (current page.south west) -- (current page.south east) --
      ([yshift=0.5cm]current page.south east) -- ([yshift=0.5cm]current page.south west) -- cycle;
    \node [yshift=1.25cm] at (current page.south)
      {\small \sffamily \textsc{$from.name$}};
  \end{tikzpicture}%
}

\usepackage{atbegshi}
\pagestyle{empty}
\AtBeginShipout{\AtBeginShipoutAddToBox{\HeaderSimple\FooterSimple}}
\AtBeginShipoutFirst{\HeaderDocumentDetails\FooterCompanyDetails}

\newcommand*\chapterlabel{}
\titleformat{\chapter}
  {\gdef\chapterlabel{}
   \normalfont\sffamily\Huge\bfseries\scshape}
  {\gdef\chapterlabel{\thechapter\ }}{0pt}
  {\begin{tikzpicture}[remember picture,overlay]
    \node[yshift=-3cm] at (current page.north west)
      {\begin{tikzpicture}[remember picture, overlay]
        \node[anchor=east,xshift=.9\paperwidth,rectangle,
              rounded corners=3pt,inner sep=11pt,
              fill=mpx-blue]
              {\color{white}#1};
       \end{tikzpicture}
      };
    \end{tikzpicture}
  }
\titlespacing*{\chapter}{0pt}{50pt}{-60pt}

% Set paragraph break
\setlength{\parskip}{1em}

% Command required by how Pandoc handles the list conversion
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

% TABLE CUSTOMIZATION
%--------------------------------
\usepackage{spreadtab}
\titlespacing*{\section}{0pt}{3pt}{-7pt} % Remove margin bottom from the title
\usepackage{arydshln} % For the dotted line on the table
\renewcommand{\arraystretch}{1.5} % Apply vertical padding to table cells
\usepackage{hhline} % For single-cell borders
\usepackage{enumitem} % For customizing lists
\setlist{nolistsep} % No whitespace around list items
\setlist[itemize]{leftmargin=0.5cm} % Reduce list left indent
\setlength{\tabcolsep}{9pt} % Larger gutter between columns


% LANGUAGE
%--------------------------------
$if(lang)$
\usepackage{polyglossia}
\setmainlanguage{$lang.name$}
$endif$

% PDF SETUP
%--------------------------------
\usepackage[xetex, bookmarks, colorlinks, breaklinks]{hyperref}
\hypersetup
{
  pdfauthor={$from.name$},
  pdfsubject=$lang.invoice-number-text$ $invoice.number$,
  pdftitle=$lang.invoice-number-text$ $invoice.number$,
  linkcolor=mpx-blue,
  citecolor=mpx-blue,
  filecolor=mpx-brown,
  urlcolor=mpx-blue
}
\urlstyle{same}

% src https://tex.stackexchange.com/questions/152392/date-format-yyyy-mm-dd
\def\mydate{\leavevmode\hbox{\the\year-\the\month-\the\day}}
\def\twodigits#1{\ifnum#1<10 0\fi\the#1}

% DOCUMENT
%--------------------------------
\begin{document}

\chapter{$lang.invoice-text$}

\normalsize \sffamily
\textsc{\textbf{$from.name$}}\\
$from.vat$\\

\vspace{1em}

\normalsize \sffamily
\textsc{\textbf{$to.name$}}\\
$to.vat$\\

\vspace{6em}

\begin{flushright}
  \small
  $lang.date-text$: $if(invoice.date-value)$$invoice.date-value$$else$\mydate$endif$
\end{flushright}

\vspace{1em}


\section*{\textbf{$lang.invoice-number-text$ $invoice.number$}}
\footnotesize
\newcounter{pos}
\setcounter{pos}{0}
\STautoround*{2} % Get spreadtab to always display the decimal part
$if(lang.commasep)$\STsetdecimalsep{,}$endif$ % Use comma as decimal separator

\begin{spreadtab}{{tabular}[t t t]{lp{8.2cm}r}}
  \hdashline[1pt/1pt]
  @ \noalign{\vskip 2mm} \textbf{Pos.} & @ \textbf{$lang.descriptioncolumn-text$} & @ \textbf{$lang.pricecolumn-text$ $invoice.currency$} \\ \hline
      $for(service)$ @ \noalign{\vskip 2mm} \refstepcounter{pos} \thepos 
        & @ $service.description$ 
        $if(service.details)$\newline \begin{itemize} 
          $for(service.details)$\scriptsize \item $service.details$ 
          $endfor$ \end{itemize}
          $endif$ & $service.price$\\$endfor$ \noalign{\vskip 2mm} \hline
  $if(from.vat-rate)$
    @ & @ \multicolumn{1}{r}{$lang.subtotal-text$:}                & :={sum(c1:[0,-1])} \\ \hhline{~~-}
    @ & @ \multicolumn{1}{r}{$lang.vat-text$ $from.vat-rate$\%:}   & $from.vat-rate$/100*[0,-1] \\ \hhline{~~-}
  $endif$
  @ & @ \multicolumn{1}{r}{\textbf{$lang.total-text$:}}   & \textbf{:={$if(from.vat-rate)$[0,-1]+[0,-2]$else$sum(c1:[0,-1])$endif$}} \\ \hhline{~~-}
\end{spreadtab}


\vspace{15mm}

\sffamily
\small
$closingnote$

%\chapter{$lang.timesheet-text$}
%timesheet
%\chapter{$lang.expenses-text$}
%expenses
\end{document}